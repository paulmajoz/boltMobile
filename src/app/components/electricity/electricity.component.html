<div class="min-h-screen bg-gray-50 flex flex-col">
  <app-header></app-header>

  <main class="flex-1 p-4 sm:p-10">
    <!-- Saved Meters -->
    <div class="mb-8">
      <section>
        <h3 class="font-bold mb-4 text-sm sm:text-2xl">Saved Electricity Meter Numbers</h3>

        <!-- Add New Meter -->
        <div class="flex flex-col sm:flex-row gap-3 items-center mb-5">
          <input
            [(ngModel)]="newMeter"
            placeholder="Add new meter"
            class="border-2 border-gray-300 rounded-xl px-3 py-2 text-sm sm:text-base w-full sm:flex-1"
          />
          <button
            (click)="addMeter()"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-xl text-sm sm:text-base w-full sm:w-auto sm:min-w-[100px]"
          >
            Add
          </button>
        </div>

        <!-- Meter List -->
        <div class="space-y-3 text-sm sm:text-base">
          <div
            *ngFor="let meter of electricityMeters"
            class="flex justify-between items-center bg-white p-3 rounded-xl shadow gap-3"
          >
            <span class="break-words text-left flex-1">{{ meter }}</span>

            <!-- Buttons -->
            <div class="flex gap-2">
              <button
                (click)="deleteMeter(meter)"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded text-xs sm:text-sm"
              >
                Delete
              </button>
              <button
                (click)="selectMeter(meter)"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded text-xs sm:text-sm"
              >
                Select
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Purchase Form -->
    <h3 class="text-sm sm:text-2xl font-bold text-secondary mb-4">Purchase Electricity</h3>

    <form [formGroup]="electricityForm" (ngSubmit)="purchaseElectricity()" class="flex flex-col gap-4 text-sm sm:text-base">
      <!-- Product Select -->
      <div>
        <label class="block font-bold mb-1">Select Product:</label>
        <select
          formControlName="selectedElectricityProduct"
          class="w-full border-2 border-gray-300 rounded-xl px-3 py-2"
        >
          <option *ngFor="let product of electricityProducts" [ngValue]="product">
            {{ product.product_description }} - R{{ product.product_value }}
          </option>
        </select>
        <p *ngIf="electricityForm.get('selectedElectricityProduct')?.touched && electricityForm.get('selectedElectricityProduct')?.invalid"
           class="text-red-600 text-xs mt-1">Product is required.</p>
      </div>

      <!-- Meter Number -->
      <div>
        <label class="block font-bold mb-1">Meter Number:</label>
        <input
          type="text"
          formControlName="meterNumber"
          class="w-full border-2 border-gray-300 rounded-xl px-3 py-2"
        />
        <p *ngIf="electricityForm.get('meterNumber')?.touched && electricityForm.get('meterNumber')?.invalid"
           class="text-red-600 text-xs mt-1">Meter number is required.</p>
      </div>

      <!-- Amount -->
      <div>
        <label class="block font-bold mb-1">Amount:</label>
        <div class="relative w-full">
          <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">R</span>
          <input
            type="number"
            formControlName="amountInRands"
            class="w-full border-2 border-gray-300 rounded-xl pl-8 pr-4 py-2"
          />
        </div>
        <p *ngIf="electricityForm.get('amountInRands')?.touched && electricityForm.get('amountInRands')?.hasError('required')"
           class="text-red-600 text-xs mt-1">Amount is required.</p>
        <p *ngIf="electricityForm.get('amountInRands')?.touched && electricityForm.get('amountInRands')?.hasError('min')"
           class="text-red-600 text-xs mt-1">Minimum amount is R2.</p>
        <p *ngIf="electricityForm.get('amountInRands')?.value > availableAirtimeLimit"
           class="text-red-600 text-xs mt-1">You do not have enough funds available.</p>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        [disabled]="electricityForm.invalid || isLoading"
        class="bg-green-600 hover:bg-green-700 text-white font-extrabold py-3 px-5 rounded-xl text-sm sm:text-base w-full"
      >
        <span *ngIf="!isLoading">Buy Electricity</span>
        <span *ngIf="isLoading">Processing...</span>
      </button>
    </form>

    <!-- Spinner -->
    <div *ngIf="isLoading" class="flex justify-center items-center mt-4">
      <div class="animate-spin rounded-full h-8 w-8 border-t-4 border-green-600 border-solid"></div>
    </div>

    <!-- Token Display -->
    <div *ngIf="token" class="mt-6 bg-white shadow-md rounded-xl p-4 border-2 border-green-500">
      <h4 class="text-sm sm:text-2xl font-bold text-green-700 mb-3">Token Received</h4>
      <div class="flex items-center justify-between gap-4">
        <span class="text-xs sm:text-base break-all">{{ token }}</span>
        <button
          (click)="copyTokenToClipboard()"
          class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded text-xs sm:text-sm"
        >
          Copy Token
        </button>
      </div>
    </div>
  </main>

  <!-- Home Button -->
  <button
    (click)="goHome()"
    style="bottom: 1rem; left: 1rem;"
    class="fixed bg-green-600 hover:bg-green-700 text-white font-extrabold py-4 px-6 rounded-xl text-sm sm:text-2xl shadow-xl"
  >
    Home
  </button>
</div>
